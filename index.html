<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Time Zone Map</title>
  <style>
    html, body {
      margin: 0px;
      width: 100%;
      height: 100%;
      font-family: -apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      font-weight: bold;
      color: white;
    }
    .map_item {
      position: absolute; 
      padding: 5px 10px;
      background-color: #e67e22; 
      border-radius: 3px;
      font-size: 14px;
      white-space: nowrap;
    }
    img {
      width: 100%;
    }
  </style>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script>
    function padTimeString(str) {
      return str/10 < 1 ? "0"+str : str;
    }

    // add prototype to Date object
    Date.prototype.stdTimezoneOffset = function() {
      var jan = new Date(this.getFullYear(), 0, 1);
      var jul = new Date(this.getFullYear(), 6, 1);
      return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
    }

    Date.prototype.dst = function() {
      return this.getTimezoneOffset() < this.stdTimezoneOffset();
    }

    Date.prototype.getCurrentTimeIn12HourFormat = function() {
      if(this.getHours() == 12) {
        return padTimeString(this.getHours())+":"+padTimeString(this.getMinutes())+" PM";
      } else if(this.getHours() > 12) {
        return padTimeString(this.getHours()-12)+":"+padTimeString(this.getMinutes())+" PM";
      } else {
        return padTimeString(this.getHours())+":"+padTimeString(this.getMinutes())+" AM";
      }
    }

    var height, width, lat_ratio, long_ratio;
    var differenceToGMT = (new Date()).dst() ? 25200 : 28800;

    $(document).ready(function() {
      $('.map').load(function() {
        calculateImageDimensions();

        // draw the items
        map_item = $('.map_item');
        $.each(map_item, function(i, item) {
          drawPoint($(this));
        });

        // handle time
        populateTime(true);
        setTimeout(function() {
          populateTime();
          setInterval(function() {
            if((new Date()).getMinutes() == 0) {
              populateTime(true);
            } else {
              populateTime();
            }
          }, 60000);
        }, (60-(new Date()).getSeconds())*1000);

        planes = $('.plane');
        explosions = $('.explosion');
        for(i = 0; i < planes.length; i++) {
          animatePlane($(planes[i]), $(explosions[i]));
        }
      });

      $(window).on('resize', function() {
        calculateImageDimensions();
        map_item = $('.map_item');
        $.each(map_item, function(i, item) {
          drawPoint($(this));
        });
      });
    });

    function animatePlane(plane, explosion) {
      map_items = $('.map_item');
      if(map_items.length > 1) {
        from_index = Math.floor(Math.random() * map_items.length);
        to_index = Math.floor(Math.random() * map_items.length);
        from_city = $(map_items[from_index]);
        to_city = $(map_items[to_index]);
        from_top = parseFloat(from_city.css("top"))+parseFloat(from_city.height())/2;
        from_left = parseFloat(from_city.css("left"))+parseFloat(from_city.width())/2;
        to_top = parseFloat(to_city.css("top"))+parseFloat(to_city.height())/2;
        to_left = parseFloat(to_city.css("left"))+parseFloat(to_city.width())/2;
        time = Math.sqrt(Math.pow((to_top-from_top), 2)+Math.pow((to_left-from_left), 2))*3.0;
        plane.show();
        plane.css({
          top: from_top+"px",
          left: from_left+"px"
        });
        explosion.css({
          top: to_top+"px",
          left: to_left+"px"
        });
        plane.animate({
          top: to_top+"px",
          left: to_left+"px"
        }, time);
        setTimeout(function() {
          plane.hide();
          explosion.show();
        }, time);
        setTimeout(function() {
          explosion.hide();
        }, 1000);
        setTimeout(function(){
          animatePlane(plane, explosion);
        }, time+1000);
      }
    }

    function calculateImageDimensions() {
      image = $('img');
      height = image.height();
      width = image.width();
      lat_ratio = height/170;
      long_ratio = width/360;
    }

    function populateTime(syncTime) {
      map_item = $('.map_item');
      if(syncTime) {
        $.each(map_item, function(i, item) {
          sendAPIRequest($(this));
        });
      } else {
        $.each(map_item, function(i, item) {
          incrementTime($(this));
        });
      }
    }

    function drawPoint(item) {
      current_lat = parseFloat(item.attr("lat"));
      current_long = parseFloat(item.attr("long"));
      item.css({
        top: (height/2)-(lat_ratio*current_lat)-(item.height()/2)+"px",
        left: (width/2)+(long_ratio*current_long)-(item.width()/2)+"px"
      });
      repositionOverlappingMapItems(item, parseInt(item.css("top")), parseInt(item.css("left")), item.height(), item.width());
    }

    function repositionOverlappingMapItems(item, top, left, height, width) {
      overlaps = [];
      overlaps.push(item);
      overlaps = $.merge(overlaps, getOverlappingMapItems(item, top, left, height, width));
      overlaps.sort(function(a, b) {
        return parseFloat(b.css("top"))-parseFloat(a.css("top"));
      });
      last_called = 0;
      i = 1; length = overlaps.length;
      while(i < length) {
        overlaps[i].css({ top: parseFloat(overlaps[i-1].css("top"))+overlaps[i-1].height()+10+"px" });
        if(last_called != i) {
          new_overlaps = getOverlappingMapItems(overlaps[i], parseInt(overlaps[i].css("top")), parseInt(overlaps[i].css("left")), overlaps[i].height(), overlaps[i].width());
          overlaps = $.merge(overlaps, new_overlaps);
          length = overlaps.length;
          if(new_overlaps.length > 0) {
            overlaps.sort(function(a, b) {
              return parseFloat(b.css("top"))-parseFloat(a.css("top"));
            });
            last_called = i;
            i -= 1;
          } else {
            last_called = i;
          }
        }
        i += 1;
      }
    }

    function getOverlappingMapItems(item, top, left, height, width) {
      map_items = $('.map_item');
      overlaps = [];
      $.each(map_items, function(i, curr) {
        cur_top = parseFloat($(this).css("top"));
        cur_left = parseFloat($(this).css("left"));
        cur_height = $(this).height();
        cur_width = $(this).width();
        if($(this).attr("name") !== item.attr("name")) {
          if(top+height > cur_top && left+width > cur_left && top < cur_top+cur_height && left < cur_left+cur_width) {
            overlaps.push($(this));
          }
        }
      });
      return overlaps;
    }

    function sendAPIRequest(item) {
      current_lat = parseFloat(item.attr("lat"));
      current_long = parseFloat(item.attr("long"));
      epoch = Math.round(new Date().getTime()/1000.0)+differenceToGMT;
      // item.text(item.attr("name")+" "+(new Date()).getCurrentTimeIn12HourFormat());
      // drawPoint(item);
      $.ajax({
        method: "GET",
        url: "https://maps.googleapis.com/maps/api/timezone/json",
        data: {
          location: current_lat+","+current_long,
          timestamp: epoch,
          key: "AIzaSyCusD6rxTGfrs0rJ-5AmOk6XJzdFVGNVxY"
        },
        success: function(response) {
          // console.log(response);
          current_time = Math.round(new Date().getTime()/1000.0)+differenceToGMT+response.dstOffset+response.rawOffset;
          item.text(item.attr("name")+" "+(new Date(current_time*1000)).getCurrentTimeIn12HourFormat());
          drawPoint(item);
        },
        error: function(msg) {
          console.log(msg);
        }
      });
    }

    function incrementTime(item) {
      values = item.text().split(":");
      name = values[0].substr(0, values[0].length-2);
      hour = parseInt(values[0].substr(values[0].length-2));
      minutes = parseInt(values[1].substr(0, 2));
      ampm = values[1].substr(values[1].length-2);
      minutes += 1;
      if(minutes >= 60) {
        minutes = minutes % 60;
        hour += 1;
        if(hour >= 12 && ampm == "PM") {
          hour = hour % 12;
          ampm = "AM";
        } else if(hour >= 12 && ampm == "AM") {
          hour = hour != 12 ? hour - 12 : hour;
          ampm = "PM";
        }
      }
      new_time = padTimeString(hour)+":"+padTimeString(minutes)+" "+ampm;
      item.text(name+new_time);
    }
  </script>
</head>
<body>
  <!-- Height: 1025px Width: 2048px -->
  <img class="map" src="earth.jpg" alt="">
  <!-- Latitude: -85 to 85 Longitude: -180 to 180 -->
  <div class="map_item" lat="-6.21462" long="106.84513" name="Jakarta"></div>
  <div class="map_item" lat="34.052235" long="-118.243683" name="Los Angeles"></div>
  <div class="map_item" lat="41.881832" long="-87.623177" name="Chicago"></div>
  <div class="map_item" lat="40.730610" long="-73.935242" name="New York"></div>
  <div class="map_item" lat="52.520008" long="13.404954" name="Berlin"></div>
  <div class="map_item" lat="51.508530" long="-0.076132" name="London"></div>
  <div class="map_item" lat="48.864716" long="2.349014" name="Paris"></div>
  <div class="map_item" lat="19.432608" long="-99.133209" name="Mexico City"></div>
  <div class="map_item" lat="35.652832" long="139.839478" name="Tokyo"></div>
  <div class="map_item" lat="49.246292" long="-123.116226" name="Vancouver"></div>
  <div class="map_item" lat="-12.046374" long="-77.042793" name="Lima"></div>
  <div class="map_item" lat="-22.752754" long="-42.864876" name="Rio De Janeiro"></div>
  <div class="map_item" lat="-34.603722" long="-58.381592" name="Buenos Aires"></div>
  <div class="map_item" lat="-33.918861" long="18.423300" name="Cape Town"></div>
  <div class="map_item" lat="-1.362863" long="36.834583" name="Nairobi"></div>
  <div class="map_item" lat="30.167206" long="31.594456" name="Cairo"></div>
  <div class="map_item" lat="55.751244" long="37.618423" name="Moscow"></div>
  <div class="map_item" lat="25.276987" long="55.296249" name="Dubai"></div>
  <div class="map_item" lat="39.913818" long="116.363625" name="Beijing"></div>
  <div class="map_item" lat="37.532600" long="127.024612" name="Seoul"></div>
  <div class="map_item" lat="22.383205" long="114.141907" name="Hong Kong"></div>
  <div class="map_item" lat="1.290270" long="103.851959" name="Singapore"></div>
  <div class="map_item" lat="-31.953512" long="115.857048" name="Perth"></div>
  <div class="map_item" lat="-33.865143" long="151.209900" name="Sydney"></div>
  <img class="plane" src="plane.png" alt="" style="height: 30px; width: 30px; display: none; position: absolute" />
  <img class="explosion" src="explosion.gif" alt="" style="height: 50px; width: 50px; display: none; position: absolute" />
  <img class="plane" src="plane.png" alt="" style="height: 30px; width: 30px; display: none; position: absolute" />
  <img class="explosion" src="explosion.gif" alt="" style="height: 50px; width: 50px; display: none; position: absolute" />
  <img class="plane" src="plane.png" alt="" style="height: 30px; width: 30px; display: none; position: absolute" />
  <img class="explosion" src="explosion.gif" alt="" style="height: 50px; width: 50px; display: none; position: absolute" />
  <img class="plane" src="plane.png" alt="" style="height: 30px; width: 30px; display: none; position: absolute" />
  <img class="explosion" src="explosion.gif" alt="" style="height: 50px; width: 50px; display: none; position: absolute" />
  <img class="plane" src="plane.png" alt="" style="height: 30px; width: 30px; display: none; position: absolute" />
  <img class="explosion" src="explosion.gif" alt="" style="height: 50px; width: 50px; display: none; position: absolute" />
  <img class="plane" src="plane.png" alt="" style="height: 30px; width: 30px; display: none; position: absolute" />
  <img class="explosion" src="explosion.gif" alt="" style="height: 50px; width: 50px; display: none; position: absolute" />
  <img class="plane" src="plane.png" alt="" style="height: 30px; width: 30px; display: none; position: absolute" />
  <img class="explosion" src="explosion.gif" alt="" style="height: 50px; width: 50px; display: none; position: absolute" />
</body>
</html>
